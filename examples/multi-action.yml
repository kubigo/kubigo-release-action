name: Multi-Action Deploy

on:
  push:
    branches: [main]

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    outputs:
      release-id: ${{ steps.create-release.outputs.release-id }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Build Docker Image
        run: |
          docker build -t myrepo/myapp:${{ github.sha }} .
          docker push myrepo/myapp:${{ github.sha }}
      
      - name: Create Release
        id: create-release
        uses: kubigo/release@v1
        with:
          kubigo-url: ${{ secrets.KUBIGO_URL }}
          api-key: ${{ secrets.KUBIGO_API_KEY }}
          images: myrepo/myapp:${{ github.sha }}

  approve-staging:
    needs: build-and-release
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - name: Approve Staging Release
        uses: kubigo/release/approve@v1
        with:
          kubigo-url: ${{ secrets.KUBIGO_URL }}
          api-key: ${{ secrets.KUBIGO_API_KEY }}
          release-id: ${{ needs.build-and-release.outputs.release-id }}
          comment: 'Approved by GitHub Actions'

  deploy-staging:
    needs: approve-staging
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Staging
        uses: kubigo/release/deploy@v1
        with:
          kubigo-url: ${{ secrets.KUBIGO_URL }}
          api-key: ${{ secrets.KUBIGO_API_KEY }}
          release-id: ${{ needs.build-and-release.outputs.release-id }}
